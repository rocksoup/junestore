{% doc %}
  ABOUTME: Sticky add-to-cart bar that appears on mobile when scrolling past buy buttons
  ABOUTME: Provides persistent CTA for improved mobile conversion rates

  Renders a sticky bottom bar on mobile devices that shows:
  - Product title
  - Current variant price
  - Add to Cart button

  The bar automatically shows/hides based on scroll position:
  - Hidden when buy buttons are visible in viewport
  - Shown when user scrolls past buy buttons
  - Hidden when cart notification is shown

  Parameters:
  - product: {Object} Product Liquid object (required)

  Usage:
  {% render 'sticky-add-to-cart-mobile',
    product: product
  %}
{% enddoc %}

{%- style -%}
  .sticky-add-to-cart-mobile {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgb(var(--color-background));
    border-top: 1px solid rgba(var(--color-foreground), 0.08);
    padding: 1.2rem;
    padding-bottom: calc(1.2rem + env(safe-area-inset-bottom));
    transform: translateY(100%);
    transition: transform 0.3s ease-in-out;
    z-index: 4;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
  }

  .sticky-add-to-cart-mobile.is-visible {
    transform: translateY(0);
  }

  .sticky-add-to-cart-mobile__content {
    display: flex;
    align-items: center;
    gap: 1.2rem;
    max-width: var(--page-width);
    margin: 0 auto;
  }

  .sticky-add-to-cart-mobile__info {
    flex: 1;
    min-width: 0;
  }

  .sticky-add-to-cart-mobile__title {
    font-size: 1.4rem;
    font-weight: 500;
    margin: 0 0 0.4rem 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .sticky-add-to-cart-mobile__price {
    font-size: 1.3rem;
    color: rgb(var(--color-foreground));
    margin: 0;
  }

  .sticky-add-to-cart-mobile__button {
    flex-shrink: 0;
  }

  .sticky-add-to-cart-mobile__button .button {
    min-width: auto;
    padding: 0 2rem;
    white-space: nowrap;
  }

  /* Hide when cart notification is visible */
  cart-notification.active ~ .sticky-add-to-cart-mobile,
  cart-drawer.active ~ .sticky-add-to-cart-mobile {
    transform: translateY(100%);
  }
{%- endstyle -%}

{% comment %}theme-check-disable UndefinedObject{% endcomment %}
{%- assign section_id = section.id -%}
{% comment %}theme-check-enable UndefinedObject{% endcomment %}
{%- assign product_form_id = 'product-form-' | append: section_id -%}

<div
  class="sticky-add-to-cart-mobile"
  id="StickyAddToCart-{{ section_id }}"
  data-section-id="{{ section_id }}"
  aria-hidden="true"
>
  <div class="sticky-add-to-cart-mobile__content">
    <div class="sticky-add-to-cart-mobile__info">
      <h2 class="sticky-add-to-cart-mobile__title">{{ product.title | escape }}</h2>
      <div class="sticky-add-to-cart-mobile__price" id="StickyPrice-{{ section_id }}">
        <span class="price-item price-item--regular">
          {{ product.selected_or_first_available_variant.price | money }}
        </span>
        {%- if product.selected_or_first_available_variant.compare_at_price > product.selected_or_first_available_variant.price -%}
          <span class="price-item price-item--sale">
            {{ product.selected_or_first_available_variant.compare_at_price | money }}
          </span>
        {%- endif -%}
      </div>
    </div>

    <div class="sticky-add-to-cart-mobile__button">
      <button
        type="submit"
        form="{{ product_form_id }}"
        class="button button--full-width"
        {% unless product.selected_or_first_available_variant.available %}
          disabled
        {% endunless %}
      >
        {%- if product.selected_or_first_available_variant.available -%}
          {{ 'products.product.add_to_cart' | t }}
        {%- else -%}
          {{ 'products.product.sold_out' | t }}
        {%- endif -%}
      </button>
    </div>
  </div>
</div>

<script>
  if (!customElements.get('sticky-add-to-cart-mobile')) {
    customElements.define(
      'sticky-add-to-cart-mobile',
      class StickyAddToCartMobile extends HTMLElement {
        constructor() {
          super();
          this.initAttempts = 0;
          this.initialized = false;
        }

        connectedCallback() {
          if (this.initialized || !this.isConnected) return;

          this.initAttempts += 1;
          this.sectionId = this.dataset.sectionId;
          this.stickyBar = document.getElementById(`StickyAddToCart-${this.sectionId}`);
          this.buyButtonsSection = document.querySelector(`#ProductInfo-${this.sectionId} [name="add"]`)?.closest('.product-form__buttons');

          if (!this.sectionId || !this.stickyBar || !this.buyButtonsSection) {
            if (this.initAttempts < 5) {
              requestAnimationFrame(() => this.connectedCallback());
            }
            return;
          }

          this.initialized = true;
          this.init();
        }

        init() {
          // Create intersection observer for buy buttons
          this.observer = new IntersectionObserver(
            (entries) => {
              entries.forEach((entry) => {
                // Show sticky bar when buy buttons scroll out of view
                if (entry.isIntersecting) {
                  this.hide();
                } else {
                  this.show();
                }
              });
            },
            {
              // Trigger when buy buttons are 100px from bottom of viewport
              rootMargin: '0px 0px -100px 0px',
              threshold: 0,
            }
          );

          this.observer.observe(this.buyButtonsSection);

          // Listen for variant changes via product info updates
          const priceElement = document.querySelector(`#price-${this.sectionId}`);
          if (priceElement) {
            const priceObserver = new MutationObserver(() => {
              this.syncWithMainProduct();
            });
            priceObserver.observe(priceElement, { childList: true, subtree: true });
          }

          // Sync button state with main product form
          const mainButton = document.querySelector(`#ProductInfo-${this.sectionId} [name="add"]`);
          if (mainButton) {
            const buttonObserver = new MutationObserver(() => {
              this.syncButtonState(mainButton);
            });
            buttonObserver.observe(mainButton, { attributes: true, attributeFilter: ['disabled'] });
          }
        }

        show() {
          this.stickyBar.classList.add('is-visible');
          this.stickyBar.setAttribute('aria-hidden', 'false');
        }

        hide() {
          this.stickyBar.classList.remove('is-visible');
          this.stickyBar.setAttribute('aria-hidden', 'true');
        }

        syncWithMainProduct() {
          // Sync price from main product section
          const mainPrice = document.querySelector(`#price-${this.sectionId}`);
          const stickyPrice = this.stickyBar.querySelector(`#StickyPrice-${this.sectionId}`);

          if (mainPrice && stickyPrice) {
            const priceText = mainPrice.querySelector('.price-item--regular');
            if (priceText) {
              stickyPrice.innerHTML = mainPrice.innerHTML;
            }
          }
        }

        syncButtonState(mainButton) {
          const stickyButton = this.stickyBar.querySelector('button[type="submit"]');
          if (!stickyButton || !mainButton) return;

          // Copy disabled state and text
          stickyButton.disabled = mainButton.disabled;
          const mainButtonText = mainButton.querySelector('span:not(.sold-out-message)');
          if (mainButtonText && !mainButtonText.classList.contains('hidden')) {
            stickyButton.textContent = mainButtonText.textContent;
          }
        }

        disconnectedCallback() {
          if (this.observer) {
            this.observer.disconnect();
          }
        }
      }
    );
  }
</script>

<sticky-add-to-cart-mobile data-section-id="{{ section_id }}"></sticky-add-to-cart-mobile>
